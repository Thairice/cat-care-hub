# Story 1.4: Integrate Contentful SDK and Fetch Content

## Status
**In Progress**

---

## Story

**As a** developer,
**I want** to connect the Next.js app to Contentful and fetch content via API,
**so that** the application can dynamically display CMS-managed content.

---

## Acceptance Criteria

1. Contentful JavaScript SDK installed (`contentful` package)
2. Contentful client configured in `/lib/contentful.ts` using environment variables
3. TypeScript types defined for Article, Product Recommendation, and Gallery Image content models
4. Helper function created to fetch all articles from Contentful
5. Helper function successfully retrieves sample articles in development
6. Error handling implemented for API failures (log errors, show fallback UI)
7. Basic test page created to verify Contentful integration works

---

## Tasks / Subtasks

- [ ] Install Contentful SDK (AC: 1)
  - [ ] Run `npm install contentful` in apps/web directory
  - [ ] Verify package added to package.json
  - [ ] Run `npm install` to ensure dependencies are installed

- [ ] Create Contentful client configuration (AC: 2)
  - [ ] Create `apps/web/lib/contentful.ts` file
  - [ ] Import contentful SDK
  - [ ] Configure client with Space ID and Access Token from environment variables
  - [ ] Export configured client for use in application
  - [ ] Add error handling if environment variables are missing

- [ ] Define TypeScript types for content models (AC: 3)
  - [ ] Create `apps/web/types/contentful.ts` file
  - [ ] Define `Article` type with all fields (title, slug, category, excerpt, content, featuredImage, publishDate)
  - [ ] Define `ProductRecommendation` type with all fields
  - [ ] Define `GalleryImage` type with all fields
  - [ ] Export all types

- [ ] Create helper functions to fetch content (AC: 4, 5)
  - [ ] Create `apps/web/lib/contentful-helpers.ts` file
  - [ ] Write `getAllArticles()` function to fetch all published articles
  - [ ] Write `getArticleBySlug(slug: string)` function to fetch single article
  - [ ] Add proper TypeScript typing to functions
  - [ ] Test functions return data correctly

- [ ] Implement error handling (AC: 6)
  - [ ] Add try/catch blocks to helper functions
  - [ ] Log errors to console with descriptive messages
  - [ ] Return empty arrays or null on failures
  - [ ] Add TypeScript error types

- [ ] Create test page to verify integration (AC: 7)
  - [ ] Create `apps/web/app/test-contentful/page.tsx`
  - [ ] Fetch articles using helper function
  - [ ] Display article titles and excerpts
  - [ ] Run dev server and verify articles display
  - [ ] Test error handling by temporarily breaking API key

- [ ] Final verification
  - [ ] Verify all sample articles from Story 1.3 are fetched
  - [ ] Verify TypeScript types are correct
  - [ ] Verify error handling works
  - [ ] Run build to ensure no TypeScript errors
  - [ ] Delete test page (or keep for debugging)

---

## Dev Notes

### Contentful SDK Installation

```bash
cd apps/web
npm install contentful
```

### Contentful Client Configuration

**File: `apps/web/lib/contentful.ts`**

```typescript
import { createClient } from 'contentful';

const space = process.env.CONTENTFUL_SPACE_ID;
const accessToken = process.env.CONTENTFUL_ACCESS_TOKEN;

if (!space || !accessToken) {
  throw new Error(
    'CONTENTFUL_SPACE_ID and CONTENTFUL_ACCESS_TOKEN must be set in environment variables'
  );
}

export const contentfulClient = createClient({
  space,
  accessToken,
});
```

### TypeScript Types

**File: `apps/web/types/contentful.ts`**

```typescript
import { Entry, Asset } from 'contentful';

export interface ArticleFields {
  title: string;
  slug: string;
  category: 'care-tasks' | 'behavior' | 'general';
  excerpt: string;
  content: any; // Rich text content
  featuredImage: Asset;
  publishDate: string;
}

export type ArticleEntry = Entry<ArticleFields>;

export interface ProductRecommendationFields {
  name: string;
  description: string;
  category: string;
  imageUrl?: string;
  affiliateLink: string;
  rationale: string;
}

export type ProductRecommendationEntry = Entry<ProductRecommendationFields>;

export interface GalleryImageFields {
  title: string;
  image: Asset;
  caption: string;
  category: string;
}

export type GalleryImageEntry = Entry<GalleryImageFields>;
```

### Helper Functions

**File: `apps/web/lib/contentful-helpers.ts`**

```typescript
import { contentfulClient } from './contentful';
import { ArticleEntry } from '@/types/contentful';

export async function getAllArticles(): Promise<ArticleEntry[]> {
  try {
    const response = await contentfulClient.getEntries<ArticleEntry>({
      content_type: 'article',
      order: '-fields.publishDate',
    });
    return response.items;
  } catch (error) {
    console.error('Error fetching articles from Contentful:', error);
    return [];
  }
}

export async function getArticleBySlug(slug: string): Promise<ArticleEntry | null> {
  try {
    const response = await contentfulClient.getEntries<ArticleEntry>({
      content_type: 'article',
      'fields.slug': slug,
      limit: 1,
    });
    return response.items[0] || null;
  } catch (error) {
    console.error(`Error fetching article with slug "${slug}":`, error);
    return null;
  }
}
```

### Test Page

**File: `apps/web/app/test-contentful/page.tsx`**

```typescript
import { getAllArticles } from '@/lib/contentful-helpers';

export default async function TestContentfulPage() {
  const articles = await getAllArticles();

  return (
    <div style={{ padding: '2rem' }}>
      <h1>Contentful Integration Test</h1>
      <p>Found {articles.length} articles:</p>
      <ul>
        {articles.map((article) => (
          <li key={article.sys.id}>
            <h2>{article.fields.title}</h2>
            <p>{article.fields.excerpt}</p>
            <p>
              <strong>Category:</strong> {article.fields.category}
            </p>
            <p>
              <strong>Slug:</strong> {article.fields.slug}
            </p>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### Environment Variables Required

Ensure `.env.local` contains:
```
CONTENTFUL_SPACE_ID=plfh3lxdrg91
CONTENTFUL_ACCESS_TOKEN=RNZTcuX-XfP2kOC1-RSq48oUD2zOXvDeNtkUoUUJTt4
CONTENTFUL_PREVIEW_ACCESS_TOKEN=iwKuELIAa7MCckINmw4yeiwedA5ndQe7mW2_WjuKpzk
```

### Testing

**Manual Testing:**
1. Run `npm run dev`
2. Navigate to `http://localhost:3000/test-contentful`
3. Verify both sample articles appear with correct data
4. Check browser console for errors
5. Temporarily break API key to test error handling

**No automated tests required for MVP** - focus on manual verification

### Important Notes

- Use Next.js 14 App Router (not Pages Router)
- All data fetching happens server-side by default
- Contentful SDK automatically caches responses
- Rich text content will be rendered in Story 1.6
- This story only focuses on fetching data, not displaying it beautifully

### Future Stories Dependencies

Story 1.5 will create the home page layout
Story 1.6 will display articles in a proper UI
Story 1.7 will deploy to Vercel (environment variables need to be set there too)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

---

## QA Results

*To be populated by QA agent*
